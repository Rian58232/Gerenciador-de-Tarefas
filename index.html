<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciador de Tarefas Seguro</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #0f3460;
      color: #f0f2f5;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }
    .header { margin-bottom: 20px; }
    .form-group { display: flex; gap: 10px; margin-bottom: 20px; }
    input, select, button { padding: 10px; border: none; border-radius: 5px; }
    input, select { background: rgba(255, 255, 255, 0.2); color: #f0f2f5; }
    button { background: #6b4e71; color: #fff; cursor: pointer; }
    button:hover { background: #5a4060; }
    #tarefas-list { list-style: none; }
    .tarefa-item { background: rgba(255, 255, 255, 0.1); padding: 10px; margin: 10px 0; border-radius: 5px; }
    .action-btns { margin-top: 10px; }
    .action-btns button { margin-right: 5px; }
    #login-modal, .modal-overlay { display: none; }
  </style>
</head>
<body>
  <div class="container" id="main-container" style="display: none;">
    <div class="header">
      <h1>Gerenciador de Tarefas Seguro</h1>
      <button class="clear-btn" onclick="clearRegistration()">Limpar Registro</button>
    </div>
    <div class="form-group">
      <input type="text" id="titulo" placeholder="Título da tarefa" required />
      <input type="date" id="data" min="2025-01-01" max="2025-12-31" required />
      <input type="time" id="hora" required />
      <select id="categoria" required>
        <option value="">Selecione uma categoria</option>
        <option value="Compromisso">Compromisso</option>
        <option value="Curso">Curso</option>
        <option value="Geral">Geral</option>
        <option value="Personalizada">Personalizada</option>
      </select>
      <input type="text" id="categoria-personalizada" placeholder="Escreva a categoria personalizada" style="display:none;" />
      <button onclick="adicionarTarefa()">Adicionar Tarefa</button>
    </div>
    <div class="form-group">
      <select id="filtro" onchange="carregarTarefas()">
        <option value="">Todos</option>
        <option value="pendente">Pendentes</option>
        <option value="concluído">Concluídos</option>
      </select>
    </div>
    <ul id="tarefas-list"></ul>
    <div id="notification"></div>
  </div>
  <div id="login-modal">
    <h2>Verificando Dispositivo</h2>
    <p>Configurando acesso seguro...</p>
    <button onclick="checkRegistration()">Continuar</button>
  </div>
  <div class="modal-overlay" id="modal-overlay" onclick="hideLoginModal()"></div>

  <script>
    const API_URL = 'https://gerenciador-tarefas-api-2a09.onrender.com';
    let currentDeviceKey = null;

    const categoriaSelect = document.getElementById('categoria');
    const categoriaPersonalizadaInput = document.getElementById('categoria-personalizada');
    const mainContainer = document.getElementById('main-container');
    const loginModal = document.getElementById('login-modal');
    const modalOverlay = document.getElementById('modal-overlay');

    categoriaSelect.addEventListener('change', () => {
      if (categoriaSelect.value === 'Personalizada') {
        categoriaPersonalizadaInput.style.display = 'inline-block';
      } else {
        categoriaPersonalizadaInput.style.display = 'none';
        categoriaPersonalizadaInput.value = '';
      }
    });

    async function checkRegistration() {
      try {
        let deviceKey = localStorage.getItem('deviceKey');
        if (!deviceKey) {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipResponse.json();
          const ip = ipData.ip;
          const timestamp = new Date().getTime();
          deviceKey = btoa(ip + ':' + timestamp);
          localStorage.setItem('deviceKey', deviceKey);
          console.log('Novo deviceKey gerado:', deviceKey);
        }
        currentDeviceKey = deviceKey;

        const checkResponse = await fetch(`${API_URL}/check-device?key=${encodeURIComponent(currentDeviceKey)}`);
        const checkResult = await checkResponse.json();
        console.log('Check result:', checkResult);

        if (!checkResult.registered) {
          const registerResponse = await fetch(`${API_URL}/register-device`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: currentDeviceKey })
          });
          if (!registerResponse.ok) throw new Error('Falha no registro');
        }
        loginModal.style.display = 'none';
        modalOverlay.style.display = 'none';
        mainContainer.style.display = 'block';
        carregarTarefas();
      } catch (error) {
        console.error('Erro na verificação/registro:', error);
        alert('Erro ao verificar ou registrar dispositivo. Tente novamente ou limpe o registro!');
        showLoginModal();
      }
    }

    function hideLoginModal() {
      loginModal.style.display = 'none';
      modalOverlay.style.display = 'none';
    }

    function showLoginModal() {
      loginModal.style.display = 'block';
      modalOverlay.style.display = 'block';
    }

    window.onload = showLoginModal;

    async function clearRegistration() {
      if (!currentDeviceKey) {
        alert('Nenhum dispositivo registrado para limpar!');
        return;
      }
      if (confirm('Tem certeza que deseja limpar o registro?')) {
        await fetch(`${API_URL}/clear-device?key=${currentDeviceKey}`, { method: 'DELETE' });
        localStorage.removeItem('deviceKey');
        showLoginModal();
        mainContainer.style.display = 'none';
        currentDeviceKey = null;
        alert('Registro limpo! Faça login novamente.');
      }
    }

    async function adicionarTarefa() {
      if (!currentDeviceKey) {
        alert('Faça login primeiro!');
        return;
      }
      const titulo = document.getElementById('titulo').value.trim();
      const data = document.getElementById('data').value;
      const hora = document.getElementById('hora').value;
      let categoria = document.getElementById('categoria').value;
      const now = new Date();

      if (!categoria) {
        alert('Selecione uma categoria!');
        return;
      }
      if (categoria === 'Personalizada') {
        const customCategoria = document.getElementById('categoria-personalizada').value.trim();
        if (!customCategoria) {
          alert('Insira a categoria personalizada!');
          return;
        }
        categoria = customCategoria;
      }

      if (!titulo || !data || !hora) {
        alert('Preencha todos os campos!');
        return;
      }

      const tarefaDateTime = new Date(`${data}T${hora}:00-03:00`);
      if (tarefaDateTime < now) {
        alert('Data e hora não podem ser passadas!');
        return;
      }

      const response = await fetch(`${API_URL}/tarefas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ titulo, data, hora, categoria, status: 'pendente', key: currentDeviceKey })
      });

      if (response.ok) {
        document.getElementById('titulo').value = '';
        document.getElementById('data').value = '';
        document.getElementById('hora').value = '';
        document.getElementById('categoria').value = '';
        document.getElementById('categoria-personalizada').value = '';
        document.getElementById('categoria-personalizada').style.display = 'none';
        carregarTarefas();
        alert('Tarefa adicionada!');
      } else {
        const result = await response.json();
        console.error('Erro na API:', result);
        alert(`Erro: ${result.error || 'Tente novamente!'}`);
      }
    }

    async function carregarTarefas() {
      if (!currentDeviceKey) return;
      const filtro = document.getElementById('filtro').value;
      const url = `${API_URL}/tarefas?key=${encodeURIComponent(currentDeviceKey)}${filtro ? `&status=${filtro}` : ''}`;
      const response = await fetch(url);
      if (!response.ok) {
        console.error('Erro ao carregar tarefas:', await response.text());
        if (response.status === 403) {
          alert('Sessão inválida. Limpe o registro e refaça o login.');
          clearRegistration();
        }
        return;
      }
      const tarefas = await response.json();
      console.log('Tarefas recebidas:', tarefas);
      const lista = document.getElementById('tarefas-list');
      lista.innerHTML = '';

      tarefas.forEach(tarefa => {
        const li = document.createElement('li');
        li.className = 'tarefa-item';
        li.innerHTML = `<strong>Tarefa: ${tarefa.titulo}</strong><br>Categoria: ${tarefa.categoria || 'Nenhuma'} - Status: ${tarefa.status}<br>Data: ${tarefa.data} Hora: ${tarefa.hora}`;
        const btnConcluir = document.createElement('button');
        btnConcluir.textContent = tarefa.status === 'pendente' ? 'Concluir' : 'Reabrir';
        btnConcluir.onclick = () => atualizarStatus(tarefa.id, tarefa.status === 'pendente' ? 'concluído' : 'pendente');
        const btnExcluir = document.createElement('button');
        btnExcluir.textContent = 'Excluir';
        btnExcluir.onclick = () => deletarTarefa(tarefa.id);
        const actions = document.createElement('div');
        actions.className = 'action-btns';
        actions.appendChild(btnConcluir);
        actions.appendChild(btnExcluir);
        li.appendChild(actions);
        lista.appendChild(li);
      });
    }

    async function atualizarStatus(id, novoStatus) {
      if (!currentDeviceKey) return;
      const response = await fetch(`${API_URL}/tarefas/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: novoStatus })
      });
      if (response.ok) carregarTarefas();
    }

    async function deletarTarefa(id) {
      if (!currentDeviceKey) return;
      await fetch(`${API_URL}/tarefas/${id}`, { method: 'DELETE' });
      carregarTarefas();
    }
  </script>
</body>
</html>
